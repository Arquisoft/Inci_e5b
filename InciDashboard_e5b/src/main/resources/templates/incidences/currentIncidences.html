<!DOCTYPE html>
<html lang="en">
<!-- head.html -->
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="//cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
	<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
		
	<link rel="stylesheet"
		href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
	<link rel="stylesheet" href="/css/custom.css" />

<!--Load the AJAX API-->
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
var nTrue = 0;
var nFalse = 0;
$(document).ready(function(){
    $("tr").each(function(){
        $(this).children("td").each(function(){
            switch ($(this).html()) {
                case 'Sí':
                	nTrue++;
                    $(this).css("background-color", "#F00");
                break;
                case 'No':
                	nFalse++;
                    $(this).css("background-color", "#0F0");
                break;
               
            }
        })
    })
});
  // Load the Visualization API and the corechart package.
  google.charts.load('current', {'packages':['corechart']});

  // Set a callback to run when the Google Visualization API is loaded.
  google.charts.setOnLoadCallback(drawChart);

  // Callback that creates and populates a data table,
  // instantiates the pie chart, passes in the data and
  // draws it.
  function drawChart() {

    // Create the data table.
    var data = new google.visualization.DataTable();
    data.addColumn('string', 'Topping');
    data.addColumn('number', 'Slices');
    data.addRows([
      ['Incidencias no peligrosas', nFalse],
      ['Incidencias  peligrosas', nTrue],
    ]);

    // Set chart options
    var options = {'title':'Incidencias en tiempo real',
                   'width':700,
                   'height':700 };

    // Instantiate and draw our chart, passing in some options.
    var chart = new google.visualization.PieChart(document.getElementById('chart_div'));
    chart.draw(data, options);
  }
  

</script>
	
</head>

<body>
	<nav th:replace="fragments/nav" />
	
	<div class="container" style="text-align: center">
		<h2>Incidencias</h2>
			<div id="table-responsive" class="table-responsive">
				<table class="table table-hover">
					<thead>
						<tr>
							<th>id</th>
							<th>Nombre</th>
							<th>Descripcion</th>
							<th>Estado</th>
							<th>Expiracion</th>
							<th>Comentarios del operador</th>
							<th>¿Peligrosa?</th>
							<th>Localizacion</th>
						</tr>
					</thead>
					<tbody>
						<tr th:each="incidence : ${incidenceList}">
							<td th:text="${incidence.id}"></td>
							<td th:text="${incidence.name}"></td>
							<td th:text="${incidence.description}"></td>
							<td th:text="${incidence.status}" ></td>
							<td th:text="${incidence.expiration}" ></td>
							<td th:text="${incidence.operatorComments}"></td>
							<td th:text="${incidence.dangerous}? 'Sí' : 'No'" ></td>
							<td>
								<iframe width="300" height="225" frameborder="0" style="border:0"
									th:src="@{https://www.google.com/maps/embed/v1/view?key=AIzaSyAnjyWNjAWTI8Cr80Uqv0thhdpLUpm3cNk&ampcenter={location}&ampzoom=18&ampmaptype=satellite (location=${incidence.location})}" 
									allowfullscreen></iframe>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			
		<!-- WebSockets -->
		<script type="text/javascript">
			$(document).ready(function() {
				var incidencesList = $("#table-responsive");

				// defined a connection to a new socket endpoint
				var socket = new SockJS('/incidences/currentIncidences');

				var stompClient = Stomp.over(socket);

				stompClient.connect({}, function(frame) {
					// subscribe to the /topic/message endpoint
					stompClient.subscribe("/incidences/currentIncidences", function(data) {
						var incidence = data.body;
						//Aqui hay que añadir la nueva incidencia a lal ista de incidencias
						//¿?¿?¿
						incidencesList.append("<li>" + incidence + "</li>");
					});
				});
			});
		</script>
		
		<h3> Gráfico que representa el índice de incidencias Peligrosas y no Peligrosas </h3>
			      <!--Div that will hold the pie chart-->
	    <div align=center id="chart_div"></div>
        
  	</div>
 
	<footer th:replace="fragments/footer" />

</body>
</html>